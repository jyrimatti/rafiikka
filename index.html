<!DOCTYPE HTML>
<html>

<head>
	<meta charset="UTF-8">
	<style>
		#chartdiv {
			width: 100%;
			height: 500px;
		}
	</style>

	<!-- TODO
		- ennakkotietojen pilkkominen
		- junanumero labeliksi viivan myötäisesti
		- junien aikataulu ja toteuma hover yhteen?
		- nappi ratanumeron vaihtamiseksi
		- dateaxis custom formaatit
		- dateaxis custom gridlines
		- dateaxis päivälabel erikseen tuntitickien alle
		- yaxis custom gridlines
		- yaxis tuki aikataulupaikkaväleille
		- infinite scroll, eli kun scrollataan reunaan tai hypätään tyhjälle, niin siirretään xAxis min/max keskikohta vanhaan reunaan. Ja trigataan load ennakkotietodatalle
		- jump-to-date laatikko
		- aikataulupiste (erityisesti vaakasuora viiva) kertomaan "raide" eli siis kapasiteetinhallintayksikkö
		- junien sijainti mukaan
		- ratatyöt
	-->

	<script src="https://www.amcharts.com/lib/version/4.9.14/core.js"></script>
	<script src="https://www.amcharts.com/lib/version/4.9.14/charts.js"></script>
	<script src="https://www.amcharts.com/lib/version/4.9.14/lang/fi_FI.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.min.js"></script>
	<script>
		window.infraAPIUrl = 'https://rata.digitraffic.fi/infra-api/0.6/';
		window.etj2APIUrl = 'https://rata.digitraffic.fi/jeti-api/0.6/';
		window.aikatauluAPIUrl = 'https://rata.digitraffic.fi/api/v1/trains/';

		let ratanumerotUrl = infraAPIUrl + "radat.json?propertyName=ratakilometrit,ratanumero";
		let rautatieliikennepaikatUrl = infraAPIUrl + "rautatieliikennepaikat.json?propertyName=lyhenne,muutRatakmsijainnit,nimi,ratakmvalit,tunniste,tyyppi,uicKoodi,virallinenRatakmsijainti";
		let liikennepaikanOsatUrl = infraAPIUrl + "liikennepaikanosat.json?propertyName=liikennepaikka,lyhenne,muutRatakmsijainnit,nimi,tunniste,uicKoodi,virallinenRatakmsijainti";
		let raideosuudetUrl = infraAPIUrl + "aikataulupaikat.json?cql_filter=tyyppi=%27raideosuus%27&propertyName=tunniste.tunniste,tunniste.ratakmvalit,tunniste.turvalaiteNimi,tyyppi,uickoodi";
		let laituritUrl = infraAPIUrl + "aikataulupaikat.json?cql_filter=tyyppi=%27laituri%27&propertyName=tunniste.tunniste,tunniste.kuvaus,tunniste.laskennallisetRatakmvalit,tunniste.tunnus,tyyppi,uickoodi";
		let eiUrl = etj2APIUrl + 'ennakkoilmoitukset.json?cql_filter=tila=%27hyväksytty%27&propertyName=liikennevaikutusalue.laskennallisetRatakmvalit,sisainenTunniste,tunniste,voimassa';
		let loUrl = etj2APIUrl + 'loilmoitukset.json?cql_filter=tila=%27aktiivinen%27&propertyName=ensimmainenAktiivisuusaika,ratakmvalit,sisainenTunniste,tunniste,viimeinenAktiivisuusaika';
		let esUrl = etj2APIUrl + 'ennakkosuunnitelmat.json?cql_filter=tila=%27hyväksytty%27&propertyName=sisainenTunniste,tyonosat.tekopaikka.laskennallisetRatakmvalit,tunniste,voimassa';
		let vsUrl = etj2APIUrl + 'vuosisuunnitelmat.json?cql_filter=tila%3C%3E%27poistettu%27&propertyName=sisainenTunniste,tunniste,kohde.laskennallisetRatakmvalit,voimassa';

		let log = function(msg1, msg2) {
			if (console && console.log) {
				console.log(dateFns.format(new Date(), 'YYYY-MM-DD HH:mm:ss.SSS'), ":", msg1, msg2);
			}
		};

		let errorHandler = function(ev) {
			log("Virhe!", ev);
		};

		let on = function(obj, event, f) {
			obj.on(event, function(a, b, c) {
				try {
					return f(a, b, c);
				} catch (e) {
					errorHandler(e);
					throw e;
				}
			});
		};

		let add = function(obj, name, f) {
			obj.add(name, function(a, b, c) {
				try {
					return f(a, b, c);
				} catch (e) {
					errorHandler(e);
					throw e;
				}
			});
		};
		

		

		window.loadingIndicator = new am4core.DataItem();
		window.loadingIndicator.categories.aktiiviset = "";
		window.loadingIndicator.values.count = {value: 0};

		let monitor = function(ds, type) {
			ds.events.on("error", errorHandler);
			on(ds.events, "started", function() {
				loadingIndicator.setCategory("aktiiviset", loadingIndicator.categories.aktiiviset + " " + type);
				loadingIndicator.setValue("count", loadingIndicator.values.count.value + 1);
			});
			on(ds.events, "ended", function() {
				loadingIndicator.setCategory("aktiiviset", loadingIndicator.categories.aktiiviset.replace(" " + type, ""));
				loadingIndicator.setValue("count", loadingIndicator.values.count.value - 1);
			});
		}

		let luoDatasource = function(type, url, f) {
			let ds = new am4core.DataSource();
			ds.url = url;
			monitor(ds, type);
			on(ds.events, "parseended", function(ev) {
				log("Parsitaan " + type);
				var ret = {};
				Object.values(ev.target.data).flat().forEach(function(x) { f(ret, x); });
				ev.target.data = ret;
				log("Parsittu " + type);
			});
			ds.load();
			return ds;
		};

		window.ratanumerotDS = luoDatasource("Ratanumerot", ratanumerotUrl, function(ret, x) {
			let kilometrit = x.ratakilometrit.flat();
			ret[x.ratanumero] = [Math.min.apply(Math, kilometrit)*1000, Math.max.apply(Math, kilometrit)*1000+1000];
		});

		window.valittuRatanumeroDS = new am4core.DataSource();
		valittuRatanumeroDS.data = null;

		window.rautatieliikennepaikatDS = luoDatasource("Rautatieliikennepaikat", rautatieliikennepaikatUrl, function(ret, x) {
			ret[x.tunniste] = {
				ratakmSijainnit: x.muutRatakmsijainnit.concat(x.virallinenRatakmsijainti != null ? [x.virallinenRatakmsijainti] : []),
				lyhenne: x.lyhenne,
				nimi: x.nimi,
				tyyppi: x.tyyppi,
				uicKoodi: x.uicKoodi,
				ratakmvalit: x.ratakmvalit
			};
		});

		window.liikennepaikanOsatDS = luoDatasource("LiikennepaikanOsat", liikennepaikanOsatUrl, function(ret, x) {
			ret[x.tunniste] = {
				ratakmSijainnit: x.muutRatakmsijainnit.concat(x.virallinenRatakmsijainti != null ? [x.virallinenRatakmsijainti] : []),
				lyhenne: x.lyhenne,
				nimi: x.nimi,
				tyyppi: "liikennepaikanosa",
				uicKoodi: x.uicKoodi,
				ratakmvalit: x.muutRatakmsijainnit.concat(x.virallinenRatakmsijainti != null ? [x.virallinenRatakmsijainti] : []).map(function(r) {
					return {
						ratanumero: r.ratanumero,
						alku: {ratakm: r.ratakm, etaisyys: r.etaisyys},
						loppu: {ratakm: r.ratakm, etaisyys: r.etaisyys}
					};
				})
			};
		});

		window.raideosuudetDS = luoDatasource("Raideosuudet", raideosuudetUrl, function(ret, x) {
			ret[x.tunniste[0].tunniste] = {
				ratakmSijainnit: [],
				lyhenne: x.tunniste[0].turvalaiteNimi,
				nimi: x.tunniste[0].turvalaiteNimi,
				tyyppi: x.tyyppi,
				uicKoodi: x.uickoodi,
				ratakmvalit: x.tunniste[0].ratakmvalit
			};
		});

		window.laituritDS = luoDatasource("Laiturit", laituritUrl, function(ret, x) {
			ret[x.tunniste[0].tunniste] = {
				ratakmSijainnit: [],
				lyhenne: x.tunniste[0].tunnus,
				nimi: x.tunniste[0].kuvaus,
				tyyppi: x.tyyppi,
				uicKoodi: x.uickoodi,
				ratakmvalit: x.tunniste[0].laskennallisetRatakmvalit
			};
		});

		window.aikataulupaikatDS = new am4core.DataSource();
		aikataulupaikatDS.data = {};
		var apHandler = function(ev) {
			Object.values(ev.target.data).forEach(function(x) {
				if (x.uicKoodi) {
					aikataulupaikatDS.data[x.uicKoodi] = x;
				}
			});
			aikataulupaikatDS.dispatch("done", aikataulupaikatDS.data);
		};
		on(rautatieliikennepaikatDS.events, "done", apHandler);
		on(liikennepaikanOsatDS.events, "done", apHandler);
		on(raideosuudetDS.events, "done", apHandler);
		on(laituritDS.events, "done", apHandler);



		var lataaAikataulu = function(paiva, callback) {
			let aikataulutDS = new am4core.DataSource();
			aikataulutDS.url = aikatauluAPIUrl + paiva;
			monitor(aikataulutDS, paiva);
			on(aikataulutDS.events, "done", function(ev) {
				log("Parsitaan aikataulut päivälle " + paiva);
				var aikataulupaikatMap = aikataulupaikatDS.data;
				var ret = ev.target.data.filter(function(x) { return !x.cancelled; }).map(function(train) {
					let data = {
						trainData: {
							departureDate: new Date(train.departureDate),
							trainNumber: train.trainNumber,
							lahtenyt: false
						},
						rows: train.timeTableRows.map(function(row) {
							let sijainti = null;
							let paikka = aikataulupaikatMap[row.stationUICCode];
							if (paikka != null) {
								let rkm = paikka.ratakmSijainnit.filter(function(x) { return x.ratanumero == valittuRatanumeroDS.data; });
								if (rkm.length > 0) {
									sijainti = rkm[0].ratakm*1000 + rkm[0].etaisyys;
								}
							} else {
								log("Tuntematon UICKoodi! " + row.stationUICCode);
							}

							return {
								scheduledTime: new Date(row.scheduledTime),
								actualTime: row.actualTime ? new Date(row.actualTime) : null,
								sijainti: sijainti,
								paikka: paikka ? paikka.lyhenne : null,
								paaty: 0
							};
						})
					};
					if (data.rows.length > 0) {
						data.rows[0].paaty = 1;
						data.rows[data.rows.length-1].paaty = 1;
					}
					if (data.rows.find(function(x) { return x.actualTime; })) {
						data.trainData.lahtenyt = true;
					}
					return data;
				});
				log("Parsittu aikataulut päivälle " + paiva);
				callback(ret.filter(function(x) {
					return x.rows.filter(function(y) {
						return y.sijainti != null;
					}).length > 1;
				}));
				ev.target.dispose();
			});
			aikataulutDS.load();
		};
		


		window.onload = function () {
			am4core.ready(function () {
				log("Aloitetaan grafiikan alustus");
				window.chart = am4core.create("chartdiv", am4charts.XYChart);

				chart.events.on("error", errorHandler);

				chart.dummyData = {};
				chart.language.locale = am4lang_fi_FI;
				chart.arrangeTooltips = false;

				chart.legend = new am4charts.Legend();
				chart.legend.position = "right";

				chart.scrollbarX = new am4core.Scrollbar();
				chart.scrollbarY = new am4core.Scrollbar();

				//chart.cursor = new am4charts.XYCursor();
				//chart.cursor.behavior = "panXY";
				//chart.cursor.maxTooltipDistance = 10;

				function customizeGrip(grip) {
					grip.icon.disabled = true;
				}

				customizeGrip(chart.scrollbarX.startGrip);
				customizeGrip(chart.scrollbarX.endGrip); 
				customizeGrip(chart.scrollbarY.startGrip);
				customizeGrip(chart.scrollbarY.endGrip); 



				var xAxis = chart.xAxes.push(new am4charts.DateAxis());
				var yAxis = chart.yAxes.push(new am4charts.ValueAxis());

				on(chart.events, "datavalidated", function () {
					xAxis.zoomToDates(
						dateFns.addHours(new Date(), -6),
						dateFns.addHours(new Date(), 6),
						false,
    					true
					);
				});

				var buttonContainer = chart.plotContainer.createChild(am4core.Container);
				buttonContainer.shouldClone = false;
				buttonContainer.align = "right";
				buttonContainer.valign = "top";
				buttonContainer.zIndex = Number.MAX_SAFE_INTEGER;
				buttonContainer.marginTop = 5;
				buttonContainer.marginRight = 5;
				buttonContainer.layout = "horizontal";

				window.ratanumeroChanged = function(val) {
					if (val != valittuRatanumeroDS.data) {
						log("Valittiin ratanumero: " + val);
						yAxis.title.text = "(" + val + ")";
						valittuRatanumeroDS.data = val;
						yAxis.min = ratanumerotDS.data[val][0];
						yAxis.max = ratanumerotDS.data[val][1];

						valittuRatanumeroDS.dispatch("done", {target: {data: valittuRatanumeroDS.data}});
					}
				};
				var ratanumeroButton = buttonContainer.createChild(am4core.Label);
				ratanumeroButton.html = "<select id='ratanumero' onchange='window.ratanumeroChanged(this.value)'>{}</select>";
				ratanumeroButton.valign = "bottom";
				ratanumeroButton.paddingRight = 20;
				on(ratanumerotDS.events, "done", function(ev) {
					let ratanumerot = Object.keys(ev.target.data).sort();
					ratanumeroButton.html = ratanumeroButton.html.replace("{}", "<option>" + ratanumerot.join("</option><option>") + "</option>");
					ratanumeroChanged(ratanumerot[0]);
				});
				on(ratanumeroButton.events, "hit", function(ev) {
					var diff = xAxis.maxZoomed - xAxis.minZoomed;
					var delta = diff * 0.5;
					xAxis.zoomToDates(new Date(xAxis.minZoomed - delta), new Date(xAxis.maxZoomed - delta));
				});

				var scrollLeftButton = buttonContainer.createChild(am4core.Button);
				scrollLeftButton.label.text = "<";
				on(scrollLeftButton.events, "hit", function(ev) {
					var diff = xAxis.maxZoomed - xAxis.minZoomed;
					var delta = diff * 0.5;
					xAxis.zoomToDates(new Date(xAxis.minZoomed - delta), new Date(xAxis.maxZoomed - delta));
				});
				var nowButton = buttonContainer.createChild(am4core.Button);
				nowButton.label.text = "|";
				on(nowButton.events, "hit", function(ev) {
					var diff = xAxis.maxZoomed - xAxis.minZoomed;
					xAxis.zoomToDates(new Date(new Date().getTime() - diff), new Date(new Date().getTime() + diff));
				});
				var scrollRightButton = buttonContainer.createChild(am4core.Button);
				scrollRightButton.label.text = ">";
				on(scrollRightButton.events, "hit", function(ev) {
					var diff = xAxis.maxZoomed - xAxis.minZoomed;
					var delta = diff * 0.5;
					xAxis.zoomToDates(new Date(xAxis.minZoomed + delta), new Date(xAxis.maxZoomed + delta));
				});

				var zoomInButton = buttonContainer.createChild(am4core.Button);
				zoomInButton.label.text = "+";
				zoomInButton.align = "right";
				on(zoomInButton.events, "hit", function(ev) {
					var diff = xAxis.maxZoomed - xAxis.minZoomed;
					var delta = diff * 0.2;
					xAxis.zoomToDates(new Date(xAxis.minZoomed + delta), new Date(xAxis.maxZoomed - delta));
				});
				var zoomOutButton = buttonContainer.createChild(am4core.Button);
				zoomOutButton.label.text = "-";
				on(zoomOutButton.events, "hit", function(ev) {
					var diff = xAxis.maxZoomed - xAxis.minZoomed;
					var delta = diff * 0.25;
					xAxis.zoomToDates(new Date(xAxis.minZoomed - delta), new Date(xAxis.maxZoomed + delta));
				});

				window.loading = chart.plotContainer.createChild(am4core.Label);
				loading.dataItem = loadingIndicator;
				loading.fontSize = 10;
				add(loading.adapter, "text", function(text, target) {
					if (!target.dataItem) {
						return text;
					}
					let aktiiviset = target.dataItem.categories.aktiiviset;
					return aktiiviset == "" ? "" : "Ladataan: " + aktiiviset.trim().split(" ").join(", ");
				});

				xAxis.min = dateFns.addMonths(new Date(), -6);
				xAxis.max = dateFns.addMonths(new Date(), 6);
				xAxis.strictMinMax = true;
				xAxis.snapTooltip = false;
				xAxis.keepSelection = true;
				xAxis.cursorTooltipEnabled = false;
				xAxis.baseInterval = { timeUnit: "second" };

				xAxis.renderer.labels.template.location = 0.0001;
				xAxis.renderer.labels.template.tooltip = new am4core.Tooltip();
				xAxis.renderer.labels.template.tooltipText = "{value.formatDate('yyyy-MM-dd HH:mm:ss')}";
				



				yAxis.snapTooltip = false;
				yAxis.keepSelection = true;
				yAxis.cursorTooltipEnabled = false;
				yAxis.extraMax = 0.1;
				yAxis.renderer.numberFormatter.numberFormat = "#";
				yAxis.renderer.labels.template.paddingRight = 40;
				add(yAxis.renderer.labels.template.adapter, "text", function(text) {
					let n = parseInt(text);
					return Math.floor(n/1000) + "+" + (n%1000);
				});

				add(yAxis.adapter, "getTooltipText", function(text) {
					let n = parseInt(text);
					return Math.floor(n/1000) + "+" + (n%1000);
				});

				

				log("Alustetaan ranget ja breakit");

				var handler = function(ev) {
					Object.values(ev.target.data).flat().forEach(function(x) {
						let radalla = x.ratakmvalit.filter(function(x) { return x.ratanumero == valittuRatanumeroDS.data; });
						radalla.forEach(function(r) {
							var range = yAxis.axisRanges.create();
							range.value = r.alku.ratakm*1000 + r.alku.etaisyys;
							range.endValue = r.loppu.ratakm*1000 + r.loppu.etaisyys;
							range.axisFill.fill = am4core.color("#396478");
							range.axisFill.fillOpacity = 0.1;
							range.grid.strokeOpacity = 0;
							range.label.inside = true;
							range.label.fontSize = 12;
							range.label.text = x.lyhenne;
							range.label.dx = -35;
							range.label.adapter.add("text", function(text) {
								return x.lyhenne;
							});
							range.label.tooltip = new am4core.Tooltip();
							range.label.tooltipText = x.tyyppi + ": " + x.nimi;


							var axisBreak = yAxis.axisBreaks.create();
							axisBreak.startValue = range.value;
							axisBreak.endValue = range.endValue;
							axisBreak.breakSize = 0.05;
							axisBreak.opacity = 0.2;
							range.label.events.on("over", function() {
								axisBreak.animate(
									[{ property: "breakSize", to: 1 }, { property: "opacity", to: 0.1 }],
									100,
									am4core.ease.sinOut
								);
							});
							range.label.events.on("hit", function() {
								axisBreak.animate(
									[{ property: "breakSize", to: 0.05 }, { property: "opacity", to: 0.2 }],
									100,
									am4core.ease.quadOut
								);
							});
						});
					});
				};
				
				on(rautatieliikennepaikatDS.events, "done", handler);
				on(liikennepaikanOsatDS.events, "done", handler);
				on(raideosuudetDS.events, "done", handler);
				on(laituritDS.events, "done", handler);
				on(valittuRatanumeroDS.events, "done", function() {
					rautatieliikennepaikatDS.load();
					liikennepaikanOsatDS.load();
					raideosuudetDS.load();
					laituritDS.load();
				});



				var luoEnnakkotieto = function(x, xs) {
					return function(rkmv) {
						let alkuRkm = rkmv.alku.ratakm*1000+rkmv.alku.etaisyys;
						let loppuRkm = rkmv.loppu.ratakm*1000+rkmv.loppu.etaisyys;
						return {
							tunniste: x.tunniste,
							sisainenTunniste: x.sisainenTunniste,
							alkuX: new Date(xs[0] < xAxis.min ? xAxis.min : xs[0]),
							loppuX: new Date(xs[1] > xAxis.max ? xAxis.max : xs[1]),
							alkuY: alkuRkm < yAxis.min ? yAxis.min : alkuRkm,
							loppuY: loppuRkm > yAxis.max ? yAxis.max : loppuRkm,
							alku: new Date(xs[0]),
							loppu: new Date(xs[1]),
							ratanumero: rkmv.ratanumero,
							alkuratakm: rkmv.alku.ratakm,
							alkuetaisyys: rkmv.alku.etaisyys,
							loppuratakm: rkmv.loppu.ratakm,
							loppuetaisyys: rkmv.loppu.etaisyys,
							zIndex: -1 * (loppuRkm - alkuRkm) * (xs[1] - xs[0])
						};
					};
				};

				chart.series.template = new am4charts.ColumnSeries()
				chart.series.template.dataFields.openValueY = "alkuY";
				chart.series.template.dataFields.valueY = "loppuY";
				chart.series.template.dataFields.openDateX = "alkuX";
				chart.series.template.dataFields.dateX = "loppuX";
				chart.series.template.cursorTooltipEnabled = false;
				chart.series.template.showOnInit = false;
				chart.series.template.simplifiedProcessing = true;
				chart.series.template.fillOpacity = 0.25;
				chart.series.template.strokeWidth = 1;
				chart.series.template.hidden = true;
				chart.series.template.columns.template.tooltipPosition = "pointer";
				chart.series.template.columns.template.tooltipText = "{sisainenTunniste}\n{tunniste}\n{alku} - {loppu}\n({ratanumero}) {alkuratakm}+{alkuetaisyys} - {loppuratakm}+{loppuetaisyys}";
				chart.series.template.columns.template.propertyFields.zIndex = "zIndex";
				let hoverState = chart.series.template.columns.template.states.create("hover");
				hoverState.properties.zIndex = 999;
				hoverState.properties.fillOpacity = 1;

				log("Alustetaan ennakkotiedot");
				var seriesEI = chart.series.create();
				seriesEI.name = "EI";
				seriesEI.fill = "orange";
				seriesEI.hidden = false;
				seriesEI.stroke = seriesEI.fill.lighten(-0.2);
				seriesEI.columns.template.states.create("hover").properties.stroke = seriesEI.stroke.lighten(-0.7);
				monitor(seriesEI.dataSource, "Ennakkoilmoitukset");
				on(seriesEI.dataSource.events, "parseended", function(ev) {
					var data = ev.target.data;
					var uusiData = [];
					for (var i = 0; i < data.length; i++) {
						var x = data[i];
						var xs = x.voimassa.split("/").map(function (d) { return new Date(d).getTime(); });
						uusiData = uusiData.concat(x.liikennevaikutusalue.laskennallisetRatakmvalit.filter(function(x) { return x.ratanumero == valittuRatanumeroDS.data; }).map(luoEnnakkotieto(x, xs)));
					}
					ev.target.data = uusiData;
				});
				seriesEI.dataSource.url = eiUrl;
				on(seriesEI.events, "shown", function() {
					seriesEI.dataSource.load();
				});
				on(valittuRatanumeroDS.events, "done", function() {
					seriesEI.dataSource.load();
				});



				log("Alustetaan loilmoitukset");
				var seriesLO = chart.series.create();
				seriesLO.name = "LOI";
				seriesLO.fill = "purple";
				seriesLO.hidden = false;
				seriesLO.stroke = seriesLO.fill.lighten(-0.2);
				seriesLO.columns.template.states.create("hover").properties.stroke = seriesLO.stroke.lighten(-0.7);
				monitor(seriesLO.dataSource, "LOilmoitukset");
				on(seriesLO.dataSource.events, "parseended", function(ev) {
					var data = ev.target.data;
					var uusiData = [];
					for (var i = 0; i < data.length; i++) {
						var x = data[i];
						var xs = [x.ensimmainenAktiivisuusaika, x.viimeinenAktiivisuusaika].map(function (d) { return new Date(d).getTime(); });
						uusiData = uusiData.concat(x.kohde.laskennallisetRatakmvalit.filter(function(x) { return x.ratanumero == valittuRatanumeroDS.data; }).map(luoEnnakkotieto(x, xs)));
					}
					ev.target.data = uusiData;
				});
				seriesLO.dataSource.url = loUrl;
				on(seriesLO.events, "shown", function() {
					seriesLO.dataSource.load();
				});
				on(valittuRatanumeroDS.events, "done", function() {
					seriesLO.dataSource.load();
				});



				log("Alustetaan ennakkosuunnitelmat");
				var seriesES = chart.series.create();
				seriesES.name = "ES";
				seriesES.fill = "green";
				seriesES.stroke = seriesES.fill.lighten(-0.2);
				seriesES.columns.template.states.create("hover").properties.stroke = seriesES.stroke.lighten(-0.7);
				monitor(seriesES.dataSource, "Ennakkosuunnitelmat");
				on(seriesES.dataSource.events, "parseended", function(ev) {
					var data = ev.target.data;
					var uusiData = [];
					for (var i = 0; i < data.length; i++) {
						var x = data[i];
						var xs = x.voimassa.split("/").map(function (d) { return new Date(d).getTime(); });
						var rkmv = x.tyonosat.flatMap(function(t) { return t.tekopaikka.laskennallisetRatakmvalit; });
						var radalla = rkmv.filter(function(x) { return x.ratanumero == valittuRatanumeroDS.data; });
						uusiData = uusiData.concat(radalla.map(luoEnnakkotieto(x, xs)));
					}
					ev.target.data = uusiData;
				});
				seriesES.dataSource.url = esUrl;
				on(seriesES.events, "shown", function() {
					seriesES.dataSource.load();
				});
				on(valittuRatanumeroDS.events, "done", function() {
					seriesES.dataSource.load();
				});



				log("Alustetaan vuosisuunnitelmat");
				var seriesVS = chart.series.create();
				seriesVS.name = "VS";
				seriesVS.fill = "violet";
				seriesVS.stroke = seriesVS.fill.lighten(-0.2);
				seriesVS.columns.template.states.create("hover").properties.stroke = seriesVS.stroke.lighten(-0.7);
				monitor(seriesVS.dataSource, "Vuosisuunnitelmat");
				on(seriesVS.dataSource.events, "parseended", function(ev) {
					var data = ev.target.data;
					var uusiData = [];
					for (var i = 0; i < data.length; i++) {
						var x = data[i];
						var xs = x.voimassa.split("/").map(function (d) { return new Date(d).getTime(); });
						uusiData = uusiData.concat(x.kohde.laskennallisetRatakmvalit.filter(function(x) { return x.ratanumero == valittuRatanumeroDS.data; }).map(luoEnnakkotieto(x, xs)));
					}
					ev.target.data = uusiData;
				});
				seriesVS.dataSource.url = vsUrl;
				on(seriesVS.events, "shown", function() {
					seriesVS.dataSource.load();
				});
				on(valittuRatanumeroDS.events, "done", function() {
					seriesVS.dataSource.load();
				});


				let useTimetables = true;
				if (useTimetables) {
					log("Alustetaan aikatauluviivat");

					chart.series.template = new am4charts.LineSeries()
					chart.series.template.strokeWidth = 1;
					chart.series.template.stroke = am4core.color("blue");
					chart.series.template.fill = am4core.color("blue");
					chart.series.template.dataFields.dateX = "scheduledTime";
					chart.series.template.dataFields.valueY = "sijainti";
					chart.series.template.cursorTooltipEnabled = false;
					chart.series.template.tooltipPosition = "pointer";
					chart.series.template.tooltipText = "Lähtöpäivä: {dummyData.departureDate}\nJunanumero: {dummyData.trainNumber}";
					chart.series.template.numberFormatter.numberFormat = "#";
					chart.series.template.showOnInit = false;
					chart.series.template.simplifiedProcessing = true;

					var aikataulutToggle = chart.series.create();
					aikataulutToggle.name = "Aikataulut";
					aikataulutToggle.hidden = true;
					on(aikataulutToggle.events, "hidden", function() {
						log("Piilotetaan aikataulut");
						chart.series.values.forEach(function(x) { if (x.name == "Aikataulu") { x.hide(); } });
					});

					on(aikataulutToggle.events, "shown", function() {
						log("Näytetään aikataulut");
						chart.series.values.forEach(function(x) { if (x.name == "Aikataulu") { x.show(); } });
					});

					var toteumatToggle = chart.series.create();
					toteumatToggle.stroke = am4core.color("red");
					toteumatToggle.fill = am4core.color("red");
					toteumatToggle.name = "Toteumat";
					toteumatToggle.hidden = true;
					on(toteumatToggle.events, "hidden", function() {
						log("Piilotetaan toteumat");
						chart.series.values.forEach(function(x) { if (x.name == "Toteuma") { x.hide(); } });
					});

					on(toteumatToggle.events, "shown", function() {
						log("Näytetään toteumat");
						chart.series.values.forEach(function(x) { if (x.name == "Toteuma") { x.show(); } });
					});

					chart.series.template.hiddenInLegend = true;

					var aikataulujenEsitysaikavali = 1000*60*60*24*3;
					chart.dummyData.ladatutLahtopaivat = {};

					var luoLineSeries = function(data) {
						data.forEach(function(train) {
							if (train.trainData.lahtenyt) {
								var series2 = chart.series.create();
								series2.name = "Toteuma";
								series2.dataFields.dateX = "actualTime";
								series2.stroke = am4core.color("red");
								series2.fill = am4core.color("red");
								series2.dummyData = train.trainData;
								series2.data = train.rows;
								series2.hidden = toteumatToggle.isHidden;

								var bullet2 = series2.bullets.push(new am4core.Circle());
								bullet2.radius = 3;
								bullet2.propertyFields.fillOpacity = "paaty";
								bullet2.states.create("hover").properties.scale = 1.5;
								bullet2.tooltipText = "{paikka}\n{actualTime.formatDate('yyyy-MM-dd HH:mm:ss')}";
								
								let segment2 = series2.segments.template;
								segment2.interactionsEnabled = true;
								segment2.states.create("hover").properties.strokeWidth = 3;
							}

							var series3 = chart.series.create();
							series3.name = "Aikataulu";
							series3.dummyData = train.trainData;
							series3.data = train.rows;
							series3.hidden = aikataulutToggle.isHidden;

							var bullet3 = series3.bullets.push(new am4core.Circle());
							bullet3.radius = 3;
							bullet3.propertyFields.fillOpacity = "paaty";
							bullet3.states.create("hover").properties.scale = 1.5;
							bullet3.tooltipText = "{paikka}\n{scheduledTime.formatDate('yyyy-MM-dd HH:mm:ss')}";

							let segment3 = series3.segments.template;
							segment3.interactionsEnabled = true;
							segment3.states.create("hover").properties.strokeWidth = 3;
						});
					};
					var haeAikataulu = function(d) {
						var paiva = dateFns.format(d, 'YYYY-MM-DD');
						if (!chart.dummyData.ladatutLahtopaivat[paiva]) {
							chart.dummyData.ladatutLahtopaivat[paiva] = true;
							lataaAikataulu(paiva, luoLineSeries);
						}
					};
					var haeAikatauluja = function() {
						let start = xAxis.minZoomed;
						let end = xAxis.maxZoomed;
						if (end-start <= aikataulujenEsitysaikavali && (!aikataulutToggle.isHidden || !toteumatToggle.isHidden)) {
							dateFns.eachDay(start, end).forEach(haeAikataulu);
						}
					};
					var poistaAikataulu = function(paiva, series) {
						log("Siivotaan pois junat lähtöpäivältä " + paiva);
						chart.dummyData.ladatutLahtopaivat[paiva] = false;
						let index = chart.series.indexOf(series);
						if (index >= 0) {
							let removed = chart.series.removeIndex(index);
							setTimeout(function() {
								log("Viivästetysti siivotaan lähtöpäivä " + paiva);
								removed.dispose();
							}, 60000);
						}
					};

					on(xAxis.events, "selectionextremeschanged", haeAikatauluja);
					on(aikataulutToggle.events, "shown", haeAikatauluja);
					on(toteumatToggle.events, "shown", haeAikatauluja);
					on(valittuRatanumeroDS.events, "done", function() {
						chart.series.values.forEach(function(x) { if (x.name == "Aikataulu" || x.name == "Toteuma") { poistaAikataulu(x); } });
						haeAikatauluja();
					});

					on(xAxis.events, "selectionextremeschanged", function(ev) {
						let start = ev.target.minZoomed;
						let end = ev.target.maxZoomed;
						if (end-start > aikataulujenEsitysaikavali) {
							log("Piilotetaan junat");
							aikataulutToggle.hide();
							toteumatToggle.hide();
							chart.series.values.forEach(function(x) { if (x.name == "Aikataulu" || x.name == "Toteuma") { x.hide(); } });
						}
					});

					let disposeFurtherThanDays = 3;
					on(xAxis.events, "selectionextremeschanged", function(ev) {
						let start = ev.target.minZoomed;
						let end = ev.target.maxZoomed;
						
						for (let i = 0; i < chart.series.values.length; ++i) {
							let series = chart.series.values[i];
							if (series.name == "Aikataulu" || series.name == "Toteuma") {
								let departureDate = series.dummyData.dd;
								if (departureDate < dateFns.addDays(start, -1*disposeFurtherThanDays) ||
									departureDate > dateFns.addDays(end,      disposeFurtherThanDays)) {

									let paiva = dateFns.format(departureDate, 'YYYY-MM-DD');
									poistaAikataulu(paiva, series);
									break;
								}
							}
						};
					});
				}



				log("Grafiikka valmis");
			});
		}
	</script>
</head>

<body>
	<div id="chartdiv"></div>
</body>

</html>